<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Web3.0门户</title>
</head>
<style>
  .collapsible {
    background-color: #eee;
    color: #444;
    cursor: pointer;
    padding: 18px;
    width: 100%;
    border: none;
    text-align: left;
    outline: none;
    font-size: 15px;
  }

  /* Add a background color to the button if it is clicked on (add the .active class with JS), and when you move the mouse over it (hover) */
  .active,
  .collapsible:hover {
    background-color: #ccc;
  }

  /* Style the collapsible content. Note: hidden by default */
  .content {
    padding: 0 18px;
    display: none;
    overflow: hidden;
    background-color: #f1f1f1;
  }
</style>

<body>
  <div style="background-color: rgb(230, 240, 240);">
<div hidden="hidden" ><textarea id="copytextarea"></textarea></div>
  <div width="100%" id="screen">
    <table border="0" id="download" align="center" width="100%">
      <tr>

        <td align="center" bgcolor="#00FFFF">
          <a href="down.html">
            <font size="6px">下载安装Hayek</font>
          </a>
        </td>
      </tr>
      <hr />
    </table>
    <font id="block" size=1>正在取得区块号 </font>
    </td>

    <hr />


    <table border="0">
      <tr>
        <td width="8%"><img src="../images/128.png" width="23"></img></td>

        <td align="left" width="30%"><text>HAYEK版本</text></td>
        <td width="100%" align="right"><text id="version" align="right">N/A</text></td>
      </tr>
    </table>
    <hr />
    <table border="0">
      <tr>
        <td width="8%"><img src="../images/favicon.ico" width="23"></img></td>

        <td align="left" width="30%"><text>IPFS连接</text></td>
        <td width="100%" align="right"><text id="ipfsnodes" align="right">N/A</text></td>
      </tr>
    </table>
    <hr />

    <table border="0">
      <tr>
        <td width="8%"><img src="../images/favicon.ico" width="23"></img></td>

        <td align="left" width="30%"><text style="font-size: 16px;">IPv6地址</text></td>
        <td width="70%" align="right"><text id="ipv6address" align="right" style="font-size: 12px;" onClick="copyAddress('http://['+window._tw_.getIPv6Address()+']:8080/ipns/k51qzi5uqu5dk1vuvvrl4m6285idnfrjo5xj5d1xsf48k63nqfi3eeuqgubr6y/down.html')">N/A</text>
        </td>
      </tr>
    </table>
    <table border="0">
      <tr>
        <td width="8%"><img src="../images/favicon.ico" width="23"></img></td>

        <td align="left" width="30%"><text style="font-size: 16px;">IPv6网络检测</text></td>
        <td width="70%" align="right">
          <text id="ipv6address" align="right" style="font-size: 18px;"
          onClick="window.location.href='https://ipw.cn/ipv6webcheck/?site=['+window._tw_.getIPv6Address()+']:8080/ipfs/'"
          >
          入站检测1
        </text>
        <text id="ipv6address" align="right" style="font-size: 18px;"
        onClick="window.location.href='https://www.itdog.cn/tcping_ipv6/['+window._tw_.getIPv6Address()+']:8080/ipfs/'"
        >
        入站检测2
      </text>
        </td>
      </tr>
    </table>
    <hr />

    <table border="0">
      <tr>
        <td width="8%"><img src="../images/favicon.ico" width="23"></img></td>

        <td align="left"><text></text></td>
        <td width="100%" align="right"><a href="http://127.0.0.1:5001/webui">管理本地IPFS</a></td>
      </tr>
    </table>
    <hr />
<div>
  <h4>为什么要IPv6地址?</h4>
   Hayek是一个去中心化的平台，通讯都是基于点对点。也就是说，您的手机，直接连接到其他人的手机。所有的通讯，都是基于IP地址。目前，IP地址分为IPv4地址和IPv6地址。比如，192.168.1.1，这是一个IPv4地址。而2409:458:4409:44::45，则是一个IPv6地址。全球43亿个IPv4地址已经全部耗尽。所以，您手机获得IPv4地址一般是192.168.x.x这样的内网地址。这种地址无法用于点对点通讯。
   而IPv6地址容量特别巨大。地址数量多到可以为地球上每一粒沙子分配一个公网IPv6地址。公网IPv6地址则可以用于P2P通讯。如果在本页看到的地址为240开头的地址，则表明您手机已经有了IPv6地址。
   如果您没有IPv6地址，您连接的其他手机数量会很少，出现各种各样的问题。比如，您挖矿的时候，出现回退的几率大增。这是因为您连接的其他手机过少，导致您即使挖出来了新的区块，由于没有及
   时的通知到其他手机，而被整个哈耶克链网络抛弃。您会发现自己挖了很久，币开始增加了，后面又突然减少了。没有IPv6，您甚至不能快速及时的同步区块。
   <h4>怎么获得IPv6地址？</h4>
   如果你在本页看到的IPv6地址，不是以240开头的，则说明您没有获得IPv6地址，最简单的方法，就是您将手机网络从Wifi切换到手机流量。中国电信移动联通的4G,5G网都是自动分配IPv6地址的。切换到手机流量上网后，您下滑屏幕刷新本页，即可看到IPv6地址。
   <h4>家里Wifi如何获得IPv6地址？</h4>
   中国的所有宽带运营商，都已经将IPv6地址下发到了光猫，您的Wifi之所以没有IPv6地址，原因其实仅仅是因为您的路由器配置错误，或者您的路由器太老而不支持IPv6。如果是您的路由器太老，我推荐您到淘宝搜索购买一台小米AC2100的Wifi6路由器，价格大约是在140元人民币，另外强烈建议你要求卖家将您的路由器刷机OpenWrt系统。一般需要额外支付20元人民币的刷机费。并且要求卖家关闭IPv6的防火墙。
   收到路由器之后，打电话给您的宽带运营商客服，要求对方派人上门帮您把光猫配置成桥接模式。并且配置好您的新路由器。使得您可以获得IPv6地址。另外，有些情况下，您可能已经获得IPv6地址，但是，外面的手机还是连接不到您的手机。这是因为有些无线路由器虽然有IPv6功能。但是，它内置了一个不可关闭的IPv6防火墙。比如，中国电信给您的H3C Magic路由器就是这种情况。
   这个时候，您就必须需要更换一个可刷OpenWrt系统的无线路由器。使得您可以关闭IPv6的防火墙。
   <h4>我已经获得了240开头的IPv6地址，如何判断无线路由器是不是有防火墙？</h4>
   <div style="background-color: aqua;" onClick="copyAddress('http://['+window._tw_.getIPv6Address()+']:8080/ipns/k51qzi5uqu5dk1vuvvrl4m6285idnfrjo5xj5d1xsf48k63nqfi3eeuqgubr6y/down.html')">点击这里复制本机HAYEK下载连接。</div>点击这里之后，会复制一个从您手机下载HAYEK软件的链接地址。打开微信，粘贴发送给您的朋友，请求您朋友先将自己的手机切换到手机流量上网状态，然后，
   复制这个链接地址到浏览器打开此网站，如果浏览器打开的页面，是一个下载Hayek软件的页面，则表明您无线路由器的防火墙已经关闭，您朋友通过手机流量直接访问到了您手机上的IPFS服务(需要你的手机此时连接家里的Wifi而不是手机流量)。您家的Wifi路由器完全配置好了IPv6。

  
</div>
  </div>
</div>
</body>
<script src="../web3.min.js"></script>
<script src="../ethers-5.2.umd.min.js" type="application/javascript"></script>
<script>
  // import { ethers } from "./ethers-5.2.esm.min.js";

  function copyAddress(text) {
    const textArea = document.createElement("textarea");
  textArea.value = text;
  document.body.appendChild(textArea);
  textArea.focus({preventScroll: true})
  textArea.select();
  try {
    document.execCommand('copy');
    alert("已经将您的IPv6地址复制，您可以粘贴到微信发送给您的朋友。")
  } catch (err) {
    console.error('Unable to copy to clipboard', err);
  }
  document.body.removeChild(textArea);
}
  function transfer(provider, address, amount) {
  
    const signer = provider.getSigner()
    const tx = signer.sendTransaction({
      to: address,
      value: ethers.utils.parseEther(amount)
    });

    tx.then((res) => {
      alert("交易已经提交上链，请等待几十秒种刷新余额。");
    }, error => {
      akert('交易失败：' + error);
    })
   
  }
  const web3 = new Web3("http://127.0.0.1:8999");
  web3.eth.isSyncing()
    .then(sync => {

      if (sync.highestBlock - sync.currentBlock > 1000) {
        window.location.href = "./syncing.html"

      }
    }

    );


  var hayekprovider
  var polygonprovider
  if (typeof window.polygon != 'undefined') {

    polygonprovider = new ethers.providers.Web3Provider(window.polygon);


  } else {
    //   alert(await polygonprovider.getBlockNumber());
    // provider=  new ethers.providers.WebSocketProvider("ws://192.168.2.20:8546");
    //provider=  new ethers.providers.WebSocketProvider("ws://192.168.2.71:8998");
    // provider=  new ethers.providers.JsonRpcProvider("http://192.168.2.71:8999");
    polygonprovider = new ethers.providers.JsonRpcProvider("https://polygon-rpc.com");

    //provider=  new ethers.providers.WebSocketProvider("ws://192.168.2.154:8998");
    //provider=  new ethers.providers.WebSocketProvider("ws://127.0.0.1:8998");

  }

  if (typeof window.hayek != 'undefined') {
    //if (true) {

    hayekprovider = new ethers.providers.Web3Provider(window.hayek)


  } else {

    provider = new ethers.providers.JsonRpcProvider("https://rpc.hayek.link");

  }

  if (typeof window.hayek != 'undefined') {

    document.getElementById("download").innerText = ""

}

setInterval(function () {


    document.getElementById("ipfsnodes").innerText = window._tw_.getIPFSnodes() + "/" + window._tw_.getIPFSPublicGateways() + "/" + window._tw_.getIPFSPublicPins()
  }, 3000);
  document.getElementById("ipfsnodes").innerText = window._tw_.getIPFSnodes() + "/" + window._tw_.getIPFSPublicGateways() + "/" + window._tw_.getIPFSPublicPins()
  document.getElementById("ipv6address").innerText = window._tw_.getIPv6Address()
  document.getElementById("version").innerText = "0."+(window._tw_.getVersion()-10000002)/1000
  


  var account = ""
  // account= await provider.send("eth_requestAccounts", []);
  var block = hayekprovider.getBlockNumber()
  block.then(res => {

    document.getElementById("block").innerText = "当前区块号：" + res
  }, error => {
    console.log('失败结果：' + error);

  });

  // const a= provider.getBlockNumber()


  hayekprovider.send("eth_requestAccounts", []).then(res => {

    account = res + ""
    document.getElementById("account").innerText = "" + account
    const d = hayekprovider.getBalance(res + "")
    d.then(res => {
      document.getElementById("balance").innerText = "" + ethers.utils.formatEther(res)
    }, error => {
      console.log('失败结果：' + error);
    });


    const dd = polygonprovider.getBalance(res + "")

    const daiAddress = "0x7125ade28ca4d0B876670dD89F952b00B7b4b9F8";
    const daiAbi = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint)",
      "function transfer(address to, uint amount)",
      "event Transfer(address indexed from, address indexed to, uint amount)"
    ];
    const daiContract = new ethers.Contract(daiAddress, daiAbi, hayekprovider);
    daiContract.balanceOf(account).then(res => {
      document.getElementById("whyk").innerText = "" + ethers.utils.formatUnits(res, 18)

    }, error => {
      console.log('失败结果：' + error);

    })

    var daiContractwhyk = new ethers.Contract("0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063", daiAbi, polygonprovider);
    daiContractwhyk.balanceOf(account).then(res => {
      document.getElementById("DAI").innerText = "" + ethers.utils.formatUnits(res, 18)

    }, error => {
      console.log('失败结果：' + error);


    })

    var daiContractwhyk = new ethers.Contract("0x9fe0B38F1FC6e96f3F403B05A347C66f7a198357", daiAbi, hayekprovider);
    daiContractwhyk.balanceOf(account).then(res => {
      document.getElementById("matichayek").innerText = "" + ethers.utils.formatUnits(res, 18)

    }, error => {
      console.log('失败结果：' + error);


    })



  }, error => {

    document.getElementById("account").innerText = "获取钱包地址失败，您应该在Hayek中使用"

  })

  //------------

  polygonprovider.send("eth_requestAccounts", []).then(res => {
    // alert("dd");
    account = res + ""
    document.getElementById("account").innerText = "" + account
    const d = polygonprovider.getBalance(res + "")
    d.then(res => {

      document.getElementById("maticbalance").innerText = "" + ethers.utils.formatEther(res)
    }, error => {
      console.log('失败结果：' + error);

    });
    const daiAddress = "0xa5E265Bf313b24476dA9681D61bDbdC03c66F271";
    const daiAbi = [
      "function name() view returns (string)",
      "function symbol() view returns (string)",
      "function balanceOf(address) view returns (uint)",
      "function transfer(address to, uint amount)",
      "event Transfer(address indexed from, address indexed to, uint amount)"
    ];
    const daiContract = new ethers.Contract(daiAddress, daiAbi, provider);
    daiContract.balanceOf(account).then(res => {
      document.getElementById("usdt").innerText = "" + ethers.utils.formatUnits(res, 8)

    }, error => {
      console.log('失败结果：' + error);

    })

    var daiContractwhyk = new ethers.Contract("0xf3DD11F7d8fA791c2Da46a5D26634592E417Af6C", daiAbi, provider);
    daiContractwhyk.balanceOf(account).then(res => {
      document.getElementById("whyk").innerText = "" + ethers.utils.formatUnits(res, 18)

    }, error => {
      console.log('失败结果：' + error);

    })



  }, error => {
    document.getElementById("account").innerText = "获取钱包地址失败，您应该在Hayek中使用"

  })
  //document.getElementById("t1").innerText="ttt"

  //console.log("ddd"+a)





  const daiAbi1 =
    [
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "id",
            "type": "uint256"
          },
          {
            "internalType": "string",
            "name": "likeText",
            "type": "string"
          }
        ],
        "name": "like",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "payable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "string",
            "name": "ipfs",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "title",
            "type": "string"
          }
        ],
        "name": "publicVideo",
        "outputs": [
          {
            "internalType": "bool",
            "name": "",
            "type": "bool"
          }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "allVideo",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "id",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "publicdatetime",
            "type": "uint256"
          },
          {
            "internalType": "address",
            "name": "publicAddr",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "ipfs",
            "type": "string"
          },
          {
            "internalType": "string",
            "name": "title",
            "type": "string"
          },
          {
            "internalType": "uint256",
            "name": "income",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          }
        ],
        "name": "balance",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "bbs",
        "outputs": [
          {
            "internalType": "address",
            "name": "poster",
            "type": "address"
          },
          {
            "internalType": "string",
            "name": "content",
            "type": "string"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "getVideoCount",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "address",
            "name": "",
            "type": "address"
          },
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "myVideo",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          {
            "internalType": "uint256",
            "name": "endLineNumber",
            "type": "uint256"
          },
          {
            "internalType": "uint256",
            "name": "MaxLines",
            "type": "uint256"
          }
        ],
        "name": "queryNewVideo",
        "outputs": [
          {
            "components": [
              {
                "internalType": "uint256",
                "name": "id",
                "type": "uint256"
              },
              {
                "internalType": "uint256",
                "name": "publicdatetime",
                "type": "uint256"
              },
              {
                "internalType": "address",
                "name": "publicAddr",
                "type": "address"
              },
              {
                "internalType": "string",
                "name": "ipfs",
                "type": "string"
              },
              {
                "internalType": "string",
                "name": "title",
                "type": "string"
              },
              {
                "internalType": "uint256",
                "name": "income",
                "type": "uint256"
              }
            ],
            "internalType": "struct NewVideo.Video[]",
            "name": "r",
            "type": "tuple[]"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      }
    ];

  const daiAddress1 = "0x7d1C275BfE0A597e11af0e2F9ECCAE73e9e0D9fE";
  //   const daiAddress1="0x61F683Bd8A9fA643Cc35e03716aD3f03797176F3";
  const daiContract1 = new ethers.Contract(daiAddress1, daiAbi1, provider);
  var s = 0
  window.anybusy = false;
  function refresh() {
    if (window.anybusy) {
      console.log("------" + window.anybusy)
      return
    }
    window.anybusy = true
    const myNode = document.getElementById("videos");
    while (myNode.firstChild) {
      myNode.removeChild(myNode.lastChild);
    }
    console.log("begin refresh:" + s)
    daiContract1.getVideoCount().then(count => {


      daiContract1.queryNewVideo(s, 10).then(res => {
        res.forEach(element => {
          console.log(element)
          AppendVideo(element.ipfs, element.id, element.title, element.publicAddr, element.publicdatetime, element.income)
          // lastvideoid = element.id

          s = element.id - 1
          if (element.id < 20) { s = 20 }
        });
        window.anybusy = false
      }, error => {
        window.anybusy = false
        // document.getElementById("video").innerText = error


        // alert(error)
      })

    }, error => {
      window.anybusy = false
      // document.getElementById("video").innerText=error

    })
  }
  if (typeof window.ethereum != 'undefined') {

    document.getElementById("download").innerText = ""

  }

  refresh()
  function getDu(ee) {
    // alert(parseInt(e.duration/60))
    //alert(ee.src+" "+ee.toSource())
    //alert(JSON.stringify(ee, null, 4));
    alert(ee.duration);
  }

  function AppendVideo(ipfs, id, title, address, posttime, income) {
    var date = new Date(posttime * 1000);
    const vfull = document.createElement("a")
    // vfull.setAttribute("width", "50%");
    vfull.setAttribute("href", "./v/?ipfs=" + ipfs + "?title=" + title + "?id=" + id)
    const p = document.createElement("video")
    p.currentTime = 0.01;
    p.src = ipfs;

    //p.src =  ipfs;
    //p.id = "video" + id;

    //p.setAttribute("controls", "{false}");
    //p.setAttribute("onloadeddata", "canplay(this)");
    // p.setAttribute("onloadeddata", "canplay(this)");

    //p.preload="{metadata}";
    //p.setAttribute("proload", "metadata");
    //  p.addEventListener("loadedmetadata",getDu(p))
    //p.addEventListener("durationchange",getDu(p))
    //p.oncanplay="{getDu(this)}"
    // p.width="100%";
    p.setAttribute("width", "100%");
    //p.autopictureinpicture = "{true}";
    vfull.appendChild(p)
    //  vfull.setAttribute("width", "50%");
    document.getElementById("videos").appendChild(vfull);

    const p1 = document.createElement("h10")
    p1.innerText = title + " \n发布者地址：" + address.toString().substring(0, 10) + "..." + address.toString().substring(30) + " \n发布时间：" + date.toDateString() + "\n 打赏收入:" + income + "HYK";
    document.getElementById("videos").appendChild(p1);
    document.getElementById("videos").appendChild(document.createElement("hr"))
    document.body.removeChild
  }


  window.onscroll = () => {
    // 变量scrollTop 是滚动条滚动时距离顶部的距离
    var scrollTop = document.documentElement.scollTop || document.body.scrollTop;
    // 变量windowHeight 是可视区的高度
    var windowHeight = document.documentElement.clientHeight || document.body.clientHeight;
    // 变量scrollHeight 是滚动条的总高度
    var scrollHeight = document.documentElement.scrollHeight;
    // 滚动条到底部的条件

    var sTop = document.body.scrollTop + document.documentElement.scrollTop;
    //  console.log("will refresh"+windowHeight+"scrollHeight "+(scrollHeight-sTop-windowHeight))
    if ((scrollHeight - sTop - windowHeight) < 5) {

      refresh()
    }

  }
  setInterval(function () {
    document.getElementById("ipfsnodes").innerText = window._tw_.getIPFSnodes() + "/" + window._tw_.getIPFSPublicGateways() + "/" + window._tw_.getIPFSPublicPins()
  }, 3000);
  document.getElementById("ipfsnodes").innerText = window._tw_.getIPFSnodes() + "/" + window._tw_.getIPFSPublicGateways() + "/" + window._tw_.getIPFSPublicPins()


  function canplay(obj) {
    //document.getElementById("video1").currentTime=0;
    obj.currentTime = 0.01
    //   alert(obj.duration)
    //   document.getElementById("t1").innerText="ttt"
  }
  function uploadipfs() {


    provider.send("get_ipfs", "fff").then(res => {

      console.log("get_ipfs:re" + res)

    }, error => {

      alert("get_ipfs:" + error)
    }, onprogress => {

    })
  }
</script>

<script>

  var coll = document.getElementsByClassName("collapsible");
  var i;

  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function () {
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.display === "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });
  }
</script>

</html>